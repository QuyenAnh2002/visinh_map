<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£n ƒë·ªì Dashboard ECET</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; background: #ffffff; }
        
        /* --- LOGO (G√≥c tr√°i tr√™n cho g·ªçn) --- */
        .logo-container {
            position: absolute; top: 15px; left: 60px; z-index: 1000; /* Chuy·ªÉn sang tr√°i ƒë·ªÉ nh∆∞·ªùng ch·ªó cho b·∫£ng */
            background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); text-align: center; max-width: 180px;
        }
        .logo-img { width: 100%; height: auto; display: block; margin-bottom: 5px; }
        .project-title { font-size: 11px; font-weight: bold; color: #004a99; text-transform: uppercase; }

        /* --- DASHBOARD C·ªê ƒê·ªäNH (Thay th·∫ø Tooltip/Popup) --- */
        .dashboard-panel {
            position: fixed;
            top: 50%;           /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
            right: 20px;        /* C·ªë ƒë·ªãnh b√™n ph·∫£i m√†n h√¨nh */
            transform: translateY(-50%); /* K·ªπ thu·∫≠t cƒÉn gi·ªØa ch√≠nh x√°c */
            width: 360px;       /* Chi·ªÅu r·ªông c·ªë ƒë·ªãnh */
            max-height: 80vh;   /* Chi·ªÅu cao t·ªëi ƒëa 80% m√†n h√¨nh */
            background: white;
            z-index: 2000;      /* N·∫±m tr√™n b·∫£n ƒë·ªì */
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); /* ƒê·ªï b√≥ng s√¢u t·∫°o chi·ªÅu s√¢u */
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Ti√™u ƒë·ªÅ Dashboard */
        .dash-header {
            background: #00695c;
            color: white;
            padding: 15px;
            text-align: center;
        }
        .dash-header h3 { margin: 0; font-size: 18px; font-weight: 700; }
        .dash-coords { font-size: 11px; color: #b2dfdb; margin-top: 5px; font-style: italic; }

        /* N·ªôi dung Dashboard */
        .dash-content {
            padding: 15px;
            overflow-y: auto; /* Cho ph√©p cu·ªôn n·∫øu b·∫£ng d√†i */
            flex-grow: 1;
        }

        /* Tr·∫°ng th√°i ch·ªù (khi ch∆∞a di chu·ªôt) */
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #777;
            font-style: italic;
        }
        .empty-icon { font-size: 40px; margin-bottom: 10px; display: block; color: #ccc; }

        /* --- Style cho Bi·ªÉu ƒë·ªì & B·∫£ng (Gi·ªØ nguy√™n) --- */
        .section-title { font-size: 12px; font-weight: bold; background: #f5f5f5; padding: 6px 10px; margin-top: 15px; border-left: 4px solid #009688; border-radius: 2px; color: #333; text-transform: uppercase; margin-bottom: 8px;}
        
        .antibiotic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; background: #fff; padding: 5px;}
        .ab-box { text-align: center; border: 1px solid #eee; padding: 8px; border-radius: 6px; }
        .ab-name { font-size: 11px; color: #666; display: block; margin-bottom: 2px; }
        .ab-val { font-size: 15px; font-weight: bold; }
        
        .val-high { color: #d32f2f; } .val-med { color: #f57c00; } .val-safe { color: #388e3c; } .val-nodata { color: #999; font-style: italic; font-size: 13px;}

        .micro-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .micro-table th { text-align: left; color: #888; font-size: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .micro-table td { padding: 8px 0; border-bottom: 1px dashed #f0f0f0; vertical-align: middle; }
        .col-type { width: 25%; font-weight: 600; color: #333; font-size: 12px;}
        
        .bar-container { width: 100%; background: #e0e0e0; height: 10px; border-radius: 5px; position: relative; overflow: hidden;}
        .bar-fill { height: 100%; background: linear-gradient(90deg, #009688, #4db6ac); border-radius: 5px; }
        .bar-label { font-size: 10px; color: #555; margin-top: 3px; font-weight: 600;}

        .pie-chart { width: 28px; height: 28px; border-radius: 50%; margin: 0 auto; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pie-legend { font-size: 10px; color: #777; text-align: center; margin-top: 2px;}

        .legend-note { font-size: 11px; margin-top: 15px; color: #666; background: #f9f9f9; padding: 10px; border-radius: 6px;}
        .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; margin-left: 8px;}
    </style>
</head>
<body>

    <div class="logo-container">
        <img src="logo.jpg" alt="Logo ECET" class="logo-img"> 
        <div class="project-title">Quan tr·∫Øc M√¥i tr∆∞·ªùng<br>T·ªìn d∆∞ & Vi sinh</div>
    </div>

    <div id="dashboard" class="dashboard-panel">
        <div class="dash-header">
            <h3>Th√¥ng tin quan tr·∫Øc</h3>
            <div class="dash-coords">--</div>
        </div>
        <div class="dash-content">
            <div class="empty-state">
                <span class="empty-icon">üëÜ</span>
                Di chuy·ªÉn chu·ªôt v√†o c√°c ƒëi·ªÉm tr√™n b·∫£n ƒë·ªì ƒë·ªÉ xem s·ªë li·ªáu chi ti·∫øt t·∫°i ƒë√¢y.
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // Zoom m·∫∑c ƒë·ªãnh l√πi ra m·ªôt ch√∫t ƒë·ªÉ th·∫•y r√µ b·ªë c·ª•c
        var map = L.map('map', {zoomControl: false}).setView([20.4, 105.8], 9); 
        L.control.zoom({position: 'bottomleft'}).addTo(map); // Chuy·ªÉn n√∫t zoom xu·ªëng g√≥c tr√°i

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 19 }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { subdomains: 'abcd', maxZoom: 19, pane: 'shadowPane' }).addTo(map);

        var targetProvinces = ["Th√†nh ph·ªë H√† N·ªôi", "T·ªânh H√† Nam", "T·ªânh Nam ƒê·ªãnh", "T·ªânh Ninh B√¨nh"];
        $.getJSON("https://raw.githubusercontent.com/daohoangson/vietnam-administrative-division-json/master/data.json", function(data) {
            L.geoJson(data, {
                style: function(feature) {
                    return targetProvinces.includes(feature.properties.name) 
                        ? { fillColor: "#9e9e9e", weight: 1, opacity: 1, color: 'white', fillOpacity: 0.2 }
                        : { fillColor: "#ffffff", weight: 1, opacity: 1, color: '#e0e0e0', fillOpacity: 0 };
                }
            }).addTo(map);
        });

        // --- H√ÄM X·ª¨ L√ù (Gi·ªØ nguy√™n logic) ---
        function getBarWidth(valStr) {
            if(!valStr) return 0;
            let num = parseFloat(valStr.toString().replace(/\./g, "").replace(",", "."));
            if (isNaN(num) || num <= 0) return 0;
            let logVal = Math.log10(num);
            let percent = (logVal / 7) * 100; 
            return percent > 100 ? 100 : (percent < 5 ? 5 : percent);
        }

        function getPieStyle(sal, pse) {
            let s = sal || 0; let p = pse || 0; let total = s + p;
            if (total === 0) return "background: #eee;";
            let salPercent = (s / total) * 100;
            return `background: conic-gradient(#ff9800 0% ${salPercent}%, #2196f3 ${salPercent}% 100%);`;
        }

        function formatAb(val) {
            if (val === null || val === undefined) return '<span class="val-nodata">--</span>';
            if (val === -1) return '<span class="val-safe">KPH</span>';
            let color = (val > 10) ? 'val-high' : 'val-med';
            return `<div class="ab-val ${color}">${val}</div><div style="font-size:10px; color:#999">ng/L</div>`;
        }

        // --- D·ªÆ LI·ªÜU ---
        var mapData = {
            "HNA": {
                lat: 20.545997, lng: 106.171562, amox: 20.12, oflo: null,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "2.826", sal: 2, pse: 3 },
                    { t: "VN N∆∞·ªõc", cfu: "26.645", sal: 3, pse: 34 },
                    { t: "B√πn", cfu: "188.708", sal: 0, pse: 3 },
                    { t: "VN B√πn", cfu: "5.870", sal: 1, pse: 3 },
                    { t: "SOM", cfu: "92.836", sal: 1, pse: 0 }
                ]
            },
            "NB1": {
                lat: 20.270168, lng: 105.980985, amox: null, oflo: null,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "2.852", sal: 3, pse: 51 },
                    { t: "VN N∆∞·ªõc", cfu: "36.975", sal: 9, pse: 2 },
                    { t: "B√πn", cfu: "1.470.833", sal: 1, pse: 1 },
                    { t: "VN B√πn", cfu: "122", sal: 5, pse: 0 },
                    { t: "SOM", cfu: "17.767", sal: 1, pse: 0 }
                ]
            },
            "NB2": {
                lat: 20.254874, lng: 106.041030, amox: 0.76, oflo: 0.10,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "1.007", sal: 2, pse: 4 },
                    { t: "VN N∆∞·ªõc", cfu: "49.106", sal: 1, pse: 2 },
                    { t: "B√πn", cfu: "1.184.444", sal: 5, pse: 0 },
                    { t: "VN B√πn", cfu: "442.255", sal: 2, pse: 2 },
                    { t: "SOM", cfu: "31.648", sal: 1, pse: 1 }
                ]
            },
            "NB3": {
                lat: 20.224119, lng: 106.100343, amox: 8.46, oflo: 0.41,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "2.183", sal: 3, pse: 11 },
                    { t: "VN N∆∞·ªõc", cfu: "37.468", sal: 0, pse: 2 },
                    { t: "B√πn", cfu: "749.444", sal: 5, pse: 10 },
                    { t: "VN B√πn", cfu: "623.500", sal: 0, pse: 0 },
                    { t: "SOM", cfu: "16.455", sal: 0, pse: 0 }
                ]
            },
            "Nƒê1": {
                lat: 20.274562, lng: 106.575639, amox: 7.16, oflo: 1.17,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "466", sal: 4, pse: 0 },
                    { t: "VN N∆∞·ªõc", cfu: "36.966", sal: 0, pse: 0 },
                    { t: "B√πn", cfu: "208.333", sal: 0, pse: 0 },
                    { t: "VN B√πn", cfu: "5.116", sal: 1, pse: 0 },
                    { t: "SOM", cfu: "13.146", sal: 0, pse: 0 }
                ]
            },
            "Nƒê2": {
                lat: 20.238269, lng: 106.586465, amox: 4.30, oflo: 1.91,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "6.133", sal: 1, pse: 2 },
                    { t: "VN N∆∞·ªõc", cfu: "44.101", sal: 0, pse: 0 },
                    { t: "B√πn", cfu: "286.666", sal: 0, pse: 0 },
                    { t: "VN B√πn", cfu: "13.050", sal: 0, pse: 0 }
                ]
            },
            "AO1": {
                lat: 19.952500, lng: 106.092778, amox: 4.25, oflo: 1.88,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "426", sal: 0, pse: 0 },
                    { t: "VN N∆∞·ªõc", cfu: "4.079", sal: 0, pse: 0 },
                    { t: "B√πn", cfu: "303.333", sal: 0, pse: 0 },
                    { t: "VN B√πn", cfu: "8.075", sal: 0, pse: 0 }
                ]
            },
            "AO2": {
                lat: 19.950556, lng: 106.093333, amox: 12.04, oflo: -1,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "114.500", sal: 0, pse: 0 },
                    { t: "VN N∆∞·ªõc", cfu: "5.243", sal: 0, pse: 0 },
                    { t: "B√πn", cfu: "286.666", sal: 0, pse: 0 },
                    { t: "VN B√πn", cfu: "6.645", sal: 0, pse: 0 }
                ]
            },
            "HN1": {
                lat: 21.002394, lng: 105.861617, amox: 11.23, oflo: 1.77,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "1.742.857", sal: 0, pse: 1 },
                    { t: "VN N∆∞·ªõc", cfu: "44.612", sal: 4, pse: 3 },
                    { t: "B√πn", cfu: "1.491.111", sal: 0, pse: 0 },
                    { t: "VN B√πn", cfu: "1.022.075", sal: 0, pse: 3 },
                    { t: "SOM", cfu: "53.111", sal: 1, pse: 0 }
                ]
            },
            "HN2": {
                lat: 20.979782, lng: 105.864387, amox: 16.25, oflo: null,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "4.741.833", sal: 4, pse: 10 },
                    { t: "VN N∆∞·ªõc", cfu: "201.000", sal: 5, pse: 0 },
                    { t: "B√πn", cfu: "2.165.833", sal: 0, pse: 0 },
                    { t: "VN B√πn", cfu: "540.082", sal: 0, pse: 0 },
                    { t: "SOM", cfu: "434.166", sal: 5, pse: 0 }
                ]
            },
            "HN3": {
                lat: 20.973038, lng: 105.852310, amox: 1.80, oflo: 0.63,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "1.567.000", sal: 0, pse: 2 },
                    { t: "VN N∆∞·ªõc", cfu: "16.177", sal: 0, pse: 0 },
                    { t: "B√πn", cfu: "741.666", sal: 0, pse: 0 },
                    { t: "VN B√πn", cfu: "521.250", sal: 1, pse: 0 },
                    { t: "SOM", cfu: "156.416", sal: 0, pse: 0 }
                ]
            },
            "HN4": {
                lat: 21.136430, lng: 105.713542, amox: 1.69, oflo: 0.58,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "933.750", sal: 0, pse: 2 },
                    { t: "VN N∆∞·ªõc", cfu: "23.962", sal: 0, pse: 0 },
                    { t: "B√πn", cfu: "1.069.166", sal: 0, pse: 0 },
                    { t: "VN B√πn", cfu: "1.266.750", sal: 0, pse: 0 },
                    { t: "SOM", cfu: "127.916", sal: 0, pse: 0 }
                ]
            },
            "HN5": {
                lat: 20.870492, lng: 105.828178, amox: 12.70, oflo: null,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "934.285", sal: 0, pse: 2 },
                    { t: "VN N∆∞·ªõc", cfu: "88.049", sal: 0, pse: 0 },
                    { t: "B√πn", cfu: "1.115.833", sal: 0, pse: 0 },
                    { t: "VN B√πn", cfu: "1.759.500", sal: 1, pse: 0 },
                    { t: "SOM", cfu: "172.500", sal: 0, pse: 0 }
                ]
            },
            "HN6": {
                lat: 20.972705, lng: 105.781089, amox: 12.14, oflo: null,
                samples: [
                    { t: "N∆∞·ªõc", cfu: "855.714", sal: 1, pse: 0 },
                    { t: "VN N∆∞·ªõc", cfu: "3.653", sal: 1, pse: 0 },
                    { t: "B√πn", cfu: "2.900.000", sal: 0, pse: 0 },
                    { t: "VN B√πn", cfu: "127.000", sal: 0, pse: 1 },
                    { t: "SOM", cfu: "90.833", sal: 0, pse: 3 }
                ]
            }
        };

        // --- RENDER B·∫¢N ƒê·ªí ---
        var dashboardHeader = document.querySelector('.dash-header h3');
        var dashboardCoords = document.querySelector('.dash-coords');
        var dashboardContent = document.querySelector('.dash-content');

        Object.keys(mapData).forEach(function(key) {
            let d = mapData[key];
            
            let marker = L.circleMarker([d.lat, d.lng], {
                radius: 8, fillColor: "#d32f2f", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8
            }).addTo(map);

            // T·∫†O S·ª∞ KI·ªÜN HOVER -> C·∫¨P NH·∫¨T DASHBOARD
            marker.on('mouseover', function (e) {
                // Highlight marker
                this.setStyle({radius: 12, color: '#ffea00', weight: 3});

                // C·∫≠p nh·∫≠t Header
                dashboardHeader.innerHTML = `ƒêi·ªÉm thu m·∫´u: ${key}`;
                dashboardCoords.innerHTML = `T·ªça ƒë·ªô: ${d.lat.toFixed(5)}, ${d.lng.toFixed(5)}`;

                // T·∫°o n·ªôi dung b·∫£ng
                let tableRows = "";
                if(d.samples) {
                    d.samples.forEach(s => {
                        let w = getBarWidth(s.cfu);
                        let pieStyle = getPieStyle(s.sal, s.pse);
                        let strainInfo = (s.sal || 0) + (s.pse || 0);

                        tableRows += `
                            <tr>
                                <td class="col-type">${s.t}</td>
                                <td style="width:45%; padding-right:15px;">
                                    <div class="bar-container">
                                        <div class="bar-fill" style="width:${w}%"></div>
                                    </div>
                                    <div class="bar-label">${s.cfu}</div>
                                </td>
                                <td style="width:30%; text-align:center;">
                                    <div class="pie-chart" style="${pieStyle}"></div>
                                    <div class="pie-legend">${strainInfo > 0 ? (s.sal||0)+"/"+(s.pse||0) : "0"}</div>
                                </td>
                            </tr>
                        `;
                    });
                }

                // C·∫≠p nh·∫≠t n·ªôi dung
                dashboardContent.innerHTML = `
                    <div class="section-title">D∆∞ l∆∞·ª£ng Kh√°ng sinh</div>
                    <div class="antibiotic-grid">
                        <div class="ab-box">
                            <span class="ab-name">Amoxicillin</span>
                            ${formatAb(d.amox)}
                        </div>
                        <div class="ab-box">
                            <span class="ab-name">Ofloxacin</span>
                            ${formatAb(d.oflo)}
                        </div>
                    </div>

                    <div class="section-title">Ch·ªâ ti√™u Vi sinh</div>
                    <table class="micro-table">
                        <thead><tr><th>Lo·∫°i</th><th>M·∫≠t ƒë·ªô (CFU)</th><th style="text-align:center">Ch·ªßng (S/P)</th></tr></thead>
                        <tbody>${tableRows}</tbody>
                    </table>

                    <div class="legend-note">
                        <span class="dot" style="background:#009688"></span>M·∫≠t ƒë·ªô (Log) &nbsp;
                        <span class="dot" style="background:#ff9800"></span>Sal &nbsp;
                        <span class="dot" style="background:#2196f3"></span>Pse
                    </div>
                `;
            });

            // Khi chu·ªôt r·ªùi ƒëi: KH√îNG X√ìA b·∫£ng ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ nh√¨n ti·∫øp
            marker.on('mouseout', function (e) {
                this.setStyle({radius: 8, color: '#fff', weight: 2}); // Tr·∫£ l·∫°i k√≠ch th∆∞·ªõc c≈©
            });
        });

    </script>
</body>
</html>